#!/usr/local/bin/nush
;;
;; nukid
;;  Nuki daemon script
;;

(load "Nu:nu")      			;; essentials
(load "Nu:cocoa")				;; wrapped frameworks
(load "Nu:console")
(load "Nu:template")

(load "nunja")

(set $site "./site")

(load "Nuki")
(load "Nuki:helpers")

;; define the application delegate class
(class ApplicationDelegate is NSObject
     (- session is $session)
     
     (- reload:sender is (reload))
     
     (- (void) applicationDidFinishLaunching: (id) sender is
        (set $session ((GitSession alloc) initInDirectory: "pages"))
        (set $server ((Nunja alloc) init))
        ($server bindToAddress: "0.0.0.0" port: "3900")
        ($server setDelegate: ((NunjaDelegate alloc) initWithSite: $site))
        ($nunja setRoot: $site)
        (preload)))

(macro reload
     (load "Nuki:git")
     (load "Nuki:macros")
     (load "Nuki:models")
     (load "Nuki:preload"))

(reload)


(global NSApp (NSApplication sharedApplication))

;; install the delegate and keep a reference to it since the application won't retain it.
(NSApp setDelegate:(set delegate ((ApplicationDelegate alloc) init)))
(delegate applicationDidFinishLaunching:nil)
($server run)


