#!/usr/local/bin/nush
;;
;; nukid
;;  Nuki daemon script
;;

(load "Nu:nu")      			;; essentials
(load "Nu:cocoa")				;; wrapped frameworks
(load "Nu:console")
(load "Nu:template")

(load "nunja")

(set $site "./site")
(set $ip "0.0.0.0")
(set $port "3900")

(load "Nuki")
(load "Nuki:git")
(load "Nuki:extensions")
(load "Nuki:helpers")

;; define the application delegate class
(class ApplicationDelegate is NSObject
     (- session is $session)
     
     (- reload:sender is (reload))
     
     (- (void) applicationDidFinishLaunching: (id) sender is
        (set $server ((Nunja alloc) init))
        ($server bindToAddress: $ip port: $port)
        ($server setDelegate: ((NunjaDelegate alloc) initWithSite: $site))
        ($nunja setRoot: $site)
        (set $session ((GitSession alloc) initInDirectory: "pages"))
        (preload)))

(macro reload
     (load "Nuki:extensions")
     (load "Nuki:helpers")
     (load "Nuki:git")
     (load "Nuki:macros")
     (load "Nuki:preload"))

(reload)


(global NSApp (NSApplication sharedApplication))

;; install the delegate and keep a reference to it since the application won't retain it.
(NSApp setDelegate:(set delegate ((ApplicationDelegate alloc) init)))
(delegate applicationDidFinishLaunching:nil)
(puts "Nuki has loaded. Surf to http://#{$ip}:#{$port}.")
($server run)


